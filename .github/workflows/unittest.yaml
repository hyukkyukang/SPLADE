name: Run-unittest

on:
  push:
    branches: [main, "unittest/**"]
  pull_request:
    branches: [main]

jobs:
  Run-unittest:
    name: Run-unittest
    runs-on: ubuntu-latest

    env:
        working-directory: ./

    strategy:
      matrix:
        python-version: ["3.12", "3.13", "3.14"]

    steps:
    # ───────────────────────────────── free disk space (run first!) ────────────────────────────────
    - name: Free disk space
      run: |
        sudo rm -rf /usr/share/dotnet
        sudo rm -rf /usr/local/lib/android
        sudo docker image prune --all --force
        sudo apt-get autoremove -y
        sudo apt-get clean
        df -h

    # ──────────────────────────────── checkout & python ────────────────────────────────
    - uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: ${{ matrix.python-version }}
        cache: pip
        cache-dependency-path: requirements.txt

    # ──────────────────────────────── pip cache ────────────────────────────────
    - name: Cache pip dependencies
      uses: actions/cache@v4
      with:
        path: ~/.cache/pip
        key: ${{ runner.os }}-pip-${{ hashFiles('requirements.txt') }}
        restore-keys: |
          ${{ runner.os }}-pip-

    # ───────────────────────────────── install deps ───────────────────────────────────
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install torch --index-url https://download.pytorch.org/whl/cpu
        pip install -r requirements.txt
        pip install faiss-cpu
        pip install --upgrade "numpy>=2.1,<2.4"
        pip install unittest-xml-reporting coverage
        pip cache purge

    # ─────────────────────────────────── auth ─────────────────────────────────────────
    - name: Hugging Face login
      if: ${{ secrets.HF_TOKEN != '' }}
      run: huggingface-cli login --token ${{ secrets.HF_TOKEN }}

    # ─────────────────────────────────── set PYTHONPATH ───────────────────────────────────
    - name: Set PYTHONPATH
      run: echo "PYTHONPATH=$PYTHONPATH:/home/runner/work/splade-repro/splade-repro" >> $GITHUB_ENV

    # ────────────────────────────── pre-download datasets ─────────────────────────────
    - name: Pre-download Hugging Face datasets
      run: |
        python -c "from datasets import load_dataset; load_dataset('BeIR/nfcorpus', 'queries', trust_remote_code=True)"
        python -c "from datasets import load_dataset; load_dataset('BeIR/nfcorpus', 'corpus', trust_remote_code=True)"

    # ────────────────────────────── generate JUnit XML via xmlrunner ────────────────────────────
    - name: Run unittest
      working-directory: ${{ env.working-directory }}
      run: python -m xmlrunner

    # ─────────────────────────────── publish results ─────────────────────────────────
    - name: Report test results
      uses: dorny/test-reporter@v2
      if: success() || failure()
      with:
          name: Python Unittest
          path: ./*.xml
          reporter: java-junit
        
    # ────────────────────────────── run coverage ──────────────────────────────
    - name: Run tests with coverage
      run: coverage run -m unittest discover -s tests

    - name: Upload coverage to Codecov
      uses: codecov/codecov-action@v5
      with:
        token: ${{ secrets.CODECOV_TOKEN }}
